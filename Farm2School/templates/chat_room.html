<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with {{ other_user.name }} - Farm2School</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: url('https://img.freepik.com/free-vector/watercolor-emerald-background_23-2150270303.jpg'); background-size: cover; background-position: center; background-attachment: fixed; }
        .chat-container { max-width: 800px; margin: 100px auto 20px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 15px; box-shadow: 0 8px 32px rgba(46,125,50,0.2); height: 80vh; display: flex; flex-direction: column; border: 1px solid rgba(76,175,80,0.3); }
        .chat-header { background: #2c8a2e; color: white; padding: 15px 20px; border-radius: 10px 10px 0 0; display: flex; align-items: center; }
        .chat-header h3 { margin-left: 10px; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; background: linear-gradient(180deg, #f1f8e9 0%, #e8f5e9 100%); }
        .message { margin-bottom: 15px; display: flex; }
        .message.sent { justify-content: flex-end; }
        .message.received { justify-content: flex-start; }
        .message-bubble { max-width: 70%; padding: 12px 16px; border-radius: 18px; word-wrap: break-word; position: relative; }
        .message.sent .message-bubble { background: linear-gradient(135deg, #2e7d32, #4caf50); color: white; box-shadow: 0 2px 8px rgba(46,125,50,0.3); }
        .message.received .message-bubble { background: linear-gradient(135deg, #f1f8e9, #e8f5e9); color: #333; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid rgba(76,175,80,0.2); }
        .message-time { font-size: 0.7rem; color: #666; margin-top: 5px; text-align: right; display: flex; align-items: center; justify-content: flex-end; gap: 3px; }
        .read-status { font-size: 0.8rem; }
        .read-status.unread { color: #999; }
        .read-status.read { color: #4fc3f7; }
        .message-actions { position: absolute; top: 5px; right: 5px; opacity: 0; transition: opacity 0.2s; }
        .message-bubble:hover .message-actions { opacity: 1; }
        .action-btn { background: rgba(0,0,0,0.1); border: none; border-radius: 50%; width: 25px; height: 25px; margin-left: 3px; cursor: pointer; }
        .media-content { max-width: 200px; border-radius: 10px; margin-bottom: 5px; }
        .media-content img, .media-content video { width: 100%; border-radius: 10px; }
        .file-upload { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .upload-btn { background: #2c8a2e; color: white; border: none; padding: 8px 12px; border-radius: 20px; cursor: pointer; }
        .edit-input { background: #f0f0f0; border: 1px solid #ddd; border-radius: 15px; padding: 8px 12px; width: 100%; }
        .deleted-message { font-style: italic; color: #999; }
        .chat-input { padding: 20px; border-top: 1px solid #eee; background: white; }
        .input-group { display: flex; gap: 10px; flex-direction: column; }
        .message-input-row { display: flex; gap: 10px; align-items: center; }
        .input-group input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; outline: none; }
        .input-group button { padding: 12px 20px; background: #2c8a2e; color: white; border: none; border-radius: 25px; cursor: pointer; }
        .back-btn { color: white; text-decoration: none; }
        .typing-indicator { padding: 10px 20px; font-style: italic; color: #666; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <a href="/messages" class="back-btn"><i class="fas fa-arrow-left"></i></a>
            <h3>{{ other_user.name }}</h3>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            {% for message in chat_messages %}
            <div class="message {{ 'sent' if message.sender_id == current_user_id else 'received' }}" id="msg-{{ message._id }}">
                <div class="message-bubble">
                    {% if message.sender_id == current_user_id and not message.get('deleted') %}
                        <div class="message-actions">
                            <button class="action-btn" onclick="editMessage('{{ message._id }}', '{{ message.message }}')"><i class="fas fa-edit"></i></button>
                            <button class="action-btn" onclick="deleteMessage('{{ message._id }}')"><i class="fas fa-trash"></i></button>
                        </div>
                    {% endif %}
                    
                    {% if message.get('deleted') %}
                        <div class="deleted-message">This message was deleted</div>
                    {% else %}
                        {% if message.get('media_type') %}
                            <div class="media-content">
                                {% if message.media_type == 'image' %}
                                    <img src="{{ message.media_url }}" alt="Image">
                                {% elif message.media_type == 'video' %}
                                    <video controls>
                                        <source src="{{ message.media_url }}" type="video/mp4">
                                    </video>
                                {% endif %}
                            </div>
                        {% endif %}
                        
                        <div class="message-text" id="text-{{ message._id }}">{{ message.message }}</div>
                        <div class="edit-form" id="edit-{{ message._id }}" style="display: none;">
                            <input type="text" class="edit-input" value="{{ message.message }}" onkeypress="handleEditKeypress(event, '{{ message._id }}')">
                            <div style="margin-top: 5px;">
                                <button onclick="saveEdit('{{ message._id }}')" class="btn btn-primary btn-small">Save</button>
                                <button onclick="cancelEdit('{{ message._id }}')" class="btn btn-outline btn-small">Cancel</button>
                            </div>
                        </div>
                    {% endif %}
                    
                    <div class="message-time">
                        {{ message.created_at.strftime('%I:%M %p') }}
                        {% if message.get('edited') %}<span style="font-size: 0.6rem; color: #999;"> (edited)</span>{% endif %}
                        {% if message.sender_id == current_user_id %}
                            <span class="read-status {{ 'read' if message.get('read') else 'unread' }}">
                                <i class="fas fa-check{{ '-double' if message.get('read') else '' }}"></i>
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="chat-input">
            <div class="input-group">
                <div class="file-upload">
                    <input type="file" id="mediaInput" accept="image/*,video/*" style="display: none;" onchange="uploadMedia()">
                    <button type="button" class="upload-btn" onclick="document.getElementById('mediaInput').click()">
                        <i class="fas fa-paperclip"></i> Media
                    </button>
                    <div id="uploadProgress" style="display: none;">Uploading...</div>
                </div>
                <form action="/send_chat_message" method="POST" class="message-input-row" onsubmit="sendMessage(event)">
                    <input type="hidden" name="recipient_id" value="{{ other_user._id }}">
                    <input type="text" name="message" id="messageInput" placeholder="Type a message..." required>
                    <button type="submit"><i class="fas fa-paper-plane"></i></button>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        // Auto scroll to bottom
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        function sendMessage(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            fetch('/send_chat_message', {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    document.getElementById('messageInput').value = '';
                    location.reload();
                }
            });
        }
        
        function uploadMedia() {
            const fileInput = document.getElementById('mediaInput');
            const file = fileInput.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('media', file);
            formData.append('recipient_id', '{{ other_user._id }}');
            
            document.getElementById('uploadProgress').style.display = 'block';
            
            fetch('/upload_media', {
                method: 'POST',
                body: formData
            }).then(response => {
                document.getElementById('uploadProgress').style.display = 'none';
                if (response.ok) {
                    location.reload();
                }
            });
        }
        
        function editMessage(messageId, currentText) {
            document.getElementById('text-' + messageId).style.display = 'none';
            document.getElementById('edit-' + messageId).style.display = 'block';
        }
        
        function cancelEdit(messageId) {
            document.getElementById('text-' + messageId).style.display = 'block';
            document.getElementById('edit-' + messageId).style.display = 'none';
        }
        
        function saveEdit(messageId) {
            const newText = document.querySelector('#edit-' + messageId + ' input').value;
            
            fetch('/edit_message', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message_id: messageId, new_text: newText})
            }).then(response => {
                if (response.ok) {
                    location.reload();
                }
            });
        }
        
        function deleteMessage(messageId) {
            if (confirm('Delete this message?')) {
                fetch('/delete_message', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message_id: messageId})
                }).then(response => {
                    if (response.ok) {
                        location.reload();
                    }
                });
            }
        }
        
        function handleEditKeypress(event, messageId) {
            if (event.key === 'Enter') {
                saveEdit(messageId);
            } else if (event.key === 'Escape') {
                cancelEdit(messageId);
            }
        }
        
        // Auto-refresh messages every 3 seconds
        setInterval(() => {
            const currentScroll = chatMessages.scrollTop;
            const maxScroll = chatMessages.scrollHeight - chatMessages.clientHeight;
            
            fetch(window.location.href)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newMessages = doc.getElementById('chatMessages').innerHTML;
                    
                    if (newMessages !== chatMessages.innerHTML) {
                        chatMessages.innerHTML = newMessages;
                        // Only scroll if user was at bottom
                        if (currentScroll >= maxScroll - 50) {
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                    }
                });
        }, 3000);
    </script>
</body>
</html>