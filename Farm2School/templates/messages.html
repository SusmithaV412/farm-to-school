<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Farm2School</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f0f2f5; }
        .chat-container { max-width: 800px; margin: 100px auto 20px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); height: 80vh; display: flex; flex-direction: column; }
        .chat-header { background: #2c8a2e; color: white; padding: 20px; border-radius: 10px 10px 0 0; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; }
        .message { margin-bottom: 15px; display: flex; }
        .message.sent { justify-content: flex-end; }
        .message.received { justify-content: flex-start; }
        .message-bubble { max-width: 70%; padding: 12px 16px; border-radius: 18px; word-wrap: break-word; }
        .message.sent .message-bubble { background: #2c8a2e; color: white; }
        .message.received .message-bubble { background: #e4e6ea; color: #333; }
        .message-info { font-size: 0.8rem; opacity: 0.7; margin-top: 5px; }
        .chat-input { padding: 20px; border-top: 1px solid #eee; }
        .input-group { display: flex; gap: 10px; }
        .input-group input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; outline: none; }
        .input-group button { padding: 12px 20px; background: #2c8a2e; color: white; border: none; border-radius: 25px; cursor: pointer; }
        .back-btn { position: absolute; top: 20px; left: 20px; background: #2c8a2e; color: white; padding: 10px 15px; border-radius: 20px; text-decoration: none; }
        .no-messages { text-align: center; padding: 50px; color: #666; }
    </style>
</head>
<body>
    {% if user_type == 'farmer' %}
        <a href="/farmer_dashboard" class="back-btn"><i class="fas fa-arrow-left"></i> Back</a>
    {% else %}
        <a href="/school_dashboard" class="back-btn"><i class="fas fa-arrow-left"></i> Back</a>
    {% endif %}
    
    <div class="chat-container">
        <div class="chat-header">
            {% if selected_farmer %}
                <h2><i class="fas fa-user"></i> Chat with {{ selected_farmer.name }}</h2>
                <p><i class="fas fa-envelope"></i> {{ selected_farmer.email }} • <i class="fas fa-map-marker-alt"></i> {{ selected_farmer.location }}</p>
            {% else %}
                <h2><i class="fas fa-comments"></i> Messages</h2>
                <p>{{ 'Chat with schools' if user_type == 'farmer' else 'Chat with farmers' }}</p>
            {% endif %}
        </div>
        
        <div class="chat-messages" id="chatMessages">
            {% if messages %}
                {% for message in messages %}
                <div class="message {{ 'sent' if message.get('is_sent') else 'received' }}">
                    <div class="message-bubble">
                        <div>{{ message.get('message', 'No content') }}</div>
                        <div class="message-info">
                            {% if message.get('is_sent') %}
                                To: {{ message.get('other_party_name', 'Unknown') }}
                            {% else %}
                                From: {{ message.get('other_party_name', 'Unknown') }}
                            {% endif %}
                            • {{ message.get('created_at').strftime('%m/%d %I:%M %p') if message.get('created_at') else 'Unknown time' }}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-messages">
                    <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 15px;"></i>
                    <h3>No messages yet</h3>
                    <p>Start a conversation by contacting {{ 'schools' if user_type == 'farmer' else 'farmers' }}</p>
                </div>
            {% endif %}
        </div>
        
        <div class="chat-input">
            {% if selected_farmer %}
                <form action="/send_message" method="POST" class="input-group">
                    <input type="hidden" name="recipient_id" value="{{ selected_farmer._id }}">
                    <input type="text" name="message" placeholder="Type a message to {{ selected_farmer.name }}..." required>
                    <button type="submit"><i class="fas fa-paper-plane"></i></button>
                </form>
            {% else %}
                <form action="/send_quick_message" method="POST" class="input-group">
                    <input type="text" name="message" placeholder="Type a message..." required>
                    <button type="submit"><i class="fas fa-paper-plane"></i></button>
                </form>
            {% endif %}
        </div>
    </div>
    
    <script>
        // Auto scroll to bottom
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // Show success message
        if (window.location.search.includes('sent=1')) {
            const input = document.querySelector('input[name="message"]');
            input.style.borderColor = '#2c8a2e';
            setTimeout(() => input.style.borderColor = '#ddd', 2000);
        }
    </script>
</body>
</html>